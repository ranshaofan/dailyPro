<!--page/index/index.wxml-->
<view class="container">
  <view class="header">
    <view class="header-top">
      <view class="date-info">
        <view class="title-row">
          <text class="title-main">今天</text>
          <text class="title-sub">{{today}}</text>
        </view>
        <view class="status-badge">
          <text class="icon-small">☀️</text>
          <text>Daily Flow</text>
        </view>
      </view>
      <view class="icon-button shadow-card">
        <image src="./resources/pic/{{helloPic}}.png" mode="widthFix"></image>
      </view>
    </view>

    <view class="stats-card shadow-card">
      <view class="stat-item">
        <text class="stat-value">{{totalCount}}</text>
        <text class="stat-label">记录片段</text>
      </view>
      <view class="divider-v"></view>
      <view class="stat-item">
        <text class="stat-value">{{totalDuration}}</text>
        <text class="stat-label">共记时长</text>
      </view>
    </view>
  </view>
  <view class="status-section">
    <text class="section-label">今日打卡</text>
    <scroll-view scroll-x class="status-tags-scroll" enable-flex>
      <block wx:for="{{checkItems}}" wx:key="flagId">
        <view class="status-tag {{item.isOpen ? 'active' : 'normal'}}" bindtap="onToggleStatus" data-id="{{item.flagId}}">
          <image class="tag-icon-img" src="../common/img/{{item.iconName}}.png" mode="aspectFit" />

          <view class="tag-text">
            <text class="tag-title">{{item.name}}</text>
            <text wx:if="{{item.isOpen}}" class="tag-desc">已完成打卡</text>
          </view>
        </view>
      </block>

      <view wx:if="{{checkItems.length === 0}}" class="empty-tips">
        <text>今日暂无打卡项</text>
      </view>
    </scroll-view>
  </view>
  <view class="section-label2">时光流水</view>
  <scroll-view scroll-y class="content-scroll">
    <view class="timeline-main">
      <view class="timeline-line"></view>

      <block wx:for="{{timelineList}}" wx:key="index">
        
        <view class="timeline-item" wx:if="{{!item.isGap}}">
          <view class="timeline-icon-wrap">
            <view class="timeline-icon" style="background-color: {{item.typeColor}}20;">
              <text class="material-icons {{item.typeClass}}" style="width: 50rpx;height:50rpx;background-color: {{item.typeColor}};margin:0;"></text>
            </view>
          </view>
          <view class="event-card shadow-card">
            <view class="card-header">
              <text class="time-range">{{item.startTime}} - {{item.endTime}}</text>
              <view class="category-badge" style="background-color: {{item.typeColor}}20;">
                <view class="dot" style="background-color: {{item.typeColor}};"></view>
                <text style="color: {{item.typeColor}};font-size: 28rpx;font-weight: 400;">{{item.typeName}}</text>
              </view>
            </view>
            <text class="event-title">{{item.textInfo}}</text>
            <view class="action-btn" hover-class="btn-hover" bindtap="onEdit" data-index="{{index}}">
              <text class="icon-edit"></text>
            </view>
            </view>
          </view>

        <view class="timeline-item" wx:else>
          <view class="timeline-dot-wrap">
            <view class="timeline-dot-small"></view>
          </view>
          <view class="gap-button" bindtap="onGapClick" data-start="{{item.startTime}}" data-end="{{item.endTime}}">
            <view class="gap-info">
              <view class="gap-header">
                <text class="time-range">{{item.startTime}} - {{item.endTime}}</text>
                <text class="gap-label">空闲</text>
              </view>
              <text class="gap-action">补记这段时间</text>
            </view>
            <view class="kongxianadd">
              <text class="material-icons icon-add add-icon"></text>
            </view>
          </view>
        </view>

      </block>
    </view>
  </scroll-view>

  <view class="bottom-action-container">
    <view class="input-main-part">
      <view class="input-toggle" bindtap="toggleInputMode">
        <text class="material-icons {{inputMode === 'voice' ? 'icon-keyboard' : 'icon-voice'}}"></text>
      </view>

      <view class="divider-line"></view>

      <view class="main-input-area">
        <view wx:if="{{inputMode === 'voice'}}" class="voice-btn-flat {{isRecording ? 'active-tap' : ''}}" bindtouchstart="startRecording" bindtouchend="stopRecording">
          <text class="material-icons icon-voice" style="font-size: 36rpx; margin-right: 8rpx;"></text>
          <text>按住说话</text>
        </view>

        <view wx:else class="text-input-wrap-flat">
          <input class="input-box" placeholder="记录此刻..." focus="{{inputMode === 'text'}}" bindconfirm="sendText" />
          <view class="send-icon" bindtap="sendText">
            <text class="material-icons icon-send" style="font-size: 40rpx;"></text>
          </view>
        </view>
      </view>
    </view>

    <view class="standalone-add-btn" bindtap="onAddTimelineShow">
      <text class="material-icons icon-add"></text>
    </view>
  </view>
</view>
<!-- 弹窗 -->
<view class="modal-mask {{showModal ? 'show' : ''}}" bindtap="hideModal">
  <view class="modal-content" catchtap="stopBubble">
    <view class="modal-handle"></view>
    <view class="modal-header">
      <text class="modal-title">{{isEditMode ? '编辑内容' : '新增记录'}}</text>
      <view class="close-btn" bindtap="hideModal">
        <text class="icon-close"></text>
      </view>
    </view>
    <scroll-view scroll-y class="modal-body">
      <view class="info-section">
        <view class="section-row">
          <text class="section-label">时间段</text>
          <text class="section-label">分类</text>
        </view>
        <view class="info-cards">
          <view class="time-card">
            <view class="time-box">
              <picker mode="time" value="{{startTime}}" bindchange="handleStartTimeChange">
                <text class="time-val">{{startTime}}</text>
              </picker>
              <text class="icon-arrow"></text>

              <picker mode="time" value="{{endTime}}" bindchange="handleEndTimeChange">
                <text class="time-val">{{endTime}}</text>
              </picker>
            </view>
          </view>
          <view class="category-selection-container">
            <view class="category-tag-large" bindtap="toggleTypePicker">
              <text class="material-icons {{selectedType.class || 'icon-book'}}" style="width: 35rpx;height: 32rpx;margin-right:10rpx;background-color: {{selectedType.color||'rgba(255, 255, 255, 0.7)'}};"></text>
              <text>{{selectedType.name || '选择分类'}}</text>
              <text class="material-icons arrow-down {{showTypePicker ? 'rotate' : ''}}"></text>
            </view>

            <view class="type-dropdown-list {{showTypePicker ? 'show' : ''}}" catchtap="stopBubble">
              <scroll-view scroll-y class="dropdown-scroll">
                <block wx:for="{{categories}}" wx:key="_id">
                  <view class="dropdown-item" wx:if="{{!item.isHidden}}" bindtap="selectType" data-item="{{item}}">
                    <view class="item-icon-circle" style="background: {{item.color}}20;">
                      <text class="material-icons iconCateWidth {{item.class}}" style="background: {{item.color}};color:{{item.color}};"></text>
                    </view>
                    <text class="item-name">{{item.name}}</text>
                    <text class="material-icons check-mark" wx:if="{{selectedType._id === item._id}}"></text>
                  </view>
                </block>
              </scroll-view>
            </view>
          </view>
        </view>
      </view>

      <view class="content-section">
        <text class="section-label">记录内容</text>
        <view class="text-area-container">
          <textarea class="content-textarea" value="" bindinput="onTextInput" maxlength="500" auto-height />
          <view class="drivelineWrap">
            <view class="driveline"></view>
          </view>
          <view class="textarea-footer">
            <view class="word-count">28 字</view>
            <view class="mic-circle">
              <text class="icon-voice"></text>
            </view>
          </view>
        </view>
      </view>
    </scroll-view>

    <view class="modal-footer">
      <view class="delete-btn" bind:tap="onDel" wx:if="{{isEditMode}}">
        <text class="icon-del"></text>
      </view>
      <view class="confirm-btn" bind:tap="onAddTimeline">
        <view class="rightWrap">
          <text class="material-icons icon-right"></text>
        </view>
        <text>完成</text>
      </view>
    </view>
  </view>
</view>